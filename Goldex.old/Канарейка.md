Канарейка в Swarm обычно делается одним из двух способов:

- **A. Через встроенный rolling-update (1–2 реплики как “канарейки”)**
    
- **B. Через два сервиса + внешний балансировщик (Traefik/NGINX) с весами**
    

Ниже — вариант А (чаще всего достаточно).

---

## A. Канареечный тест через `docker service update`

Идея: обновляем **по 1 реплике**, даём ей пожить, смотрим метрики/логи. Если ок — продолжаем, если нет — откатываем.

### 1. Задать политику обновления

Либо при создании сервиса, либо через update:

```bash
# пример: 10 реплик, обновляем по одной, с паузой,
# следим за отказами и откатываемся при проблемах
docker service create \
  --name api \
  --replicas 10 \
  --update-parallelism 1 \
  --update-delay 2m \
  --update-monitor 30s \
  --update-max-failure-ratio 0.1 \
  --update-failure-action rollback \
  --update-order start-first \
  my-api:1.0
```

Ключи:

- `--update-parallelism 1` — **канарейка**: обновляется по 1 задаче.
    
- `--update-delay 2m` — пауза между репликами (время для проверки).
    
- `--update-monitor 30s` — сколько ждать, чтобы считать задачу “устойчиво запущенной”. ([Docker Documentation](https://docs.docker.com/engine/swarm/services/?utm_source=chatgpt.com "Deploy services to a swarm"))
    
- `--update-max-failure-ratio 0.1` + `--update-failure-action rollback` — если >10% обновлённых задач упали, Swarm сам откатит.
    

### 2. Запустить канарейку (обновление образа)

```bash
docker service update \
  --image my-api:2.0 \
  api
```

Swarm:

1. Обновит **одну** реплику на `my-api:2.0`.
    
2. Подождёт `--update-monitor`.
    
3. Подождёт ещё `--update-delay`.
    
4. Только потом тронет следующую.
    

### 3. Наблюдать

- Состояние задач:
    
    ```bash
    docker service ps api
    ```
    
- Логи:
    
    ```bash
    docker service logs -f api
    ```
    
- Плюс ваши метрики / алёрты (Prometheus, Sentry и т.п.).
    

Если видите проблемы:

```bash
docker service update --rollback api
```

Swarm вернёт предыдущую конфигурацию сервиса. ([Docker Documentation](https://docs.docker.com/reference/cli/docker/service/update/?utm_source=chatgpt.com "docker service update"))

---

## B. Классическая “10% трафика” канарейка

Если нужно **строгое процентное разделение трафика**:

1. Поднимаете **два сервиса**:
    
    - `api-stable` с образом `my-api:1.0`
        
    - `api-canary` с образом `my-api:2.0`
        
2. Ставите перед Swarm **Traefik/NGINX/HAProxy**, который:
    
    - шлёт, например, 90% запросов на `api-stable`,
        
    - 10% — на `api-canary` (через веса сервисов / upstream-ов). ([GeeksforGeeks](https://www.geeksforgeeks.org/devops/zero-downtime-deployments-with-docker-swarm/?utm_source=chatgpt.com "Zero Downtime Deployments with Docker Swarm"))
        
3. Смотрите на метрики канарейки:
    
    - если ок — постепенно увеличиваете вес до 100% и отключаете старый сервис;
        
    - если плохо — просто выключаете `api-canary`.
        

---

Если скажешь, какая у тебя схема входа (прямо published порт Swarm, Traefik, Nginx, Cloud LB и т.п.), могу набросать **конкретные команды/конфиг** под твой вариант.